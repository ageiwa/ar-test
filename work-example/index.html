<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <style>
        .pos {
            left: 0;
            bottom: 0;
            position: fixed;
        }
    </style>
</head>

<body>
    <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true'>
        <a-camera camera look-controls gps-new-camera='gpsMinDistance: 5'></a-camera>
        <a-entity track-user-movement></a-entity>
    </a-scene>

    <div class="pos">
        <div class="pos-block"></div>
        <br>
        <div class="pos-camera"></div>
        <br>
        <div class="pos-gps"></div>
    </div>
</body>
<script>
    AFRAME.registerComponent('track-user-movement', {
        tick: function () {
            let camera = this.el
            let cameraPosition = camera.getAttribute('position');
        }
    })

    const options = {
        enableHighAccuracy: true,
        timeout: 1000,
        maximumAge: 0
    }

    const camera = document.querySelector('[gps-new-camera]')
    const posBlock = document.querySelector('.pos-block')
    const posCamera = document.querySelector('.pos-camera')
    const posGps = document.querySelector('.pos-gps')

    const urlParams = new URLSearchParams(window.location.search)
    const latitude = urlParams.get('latitude')
    const longitude = urlParams.get('longitude')

    let setPosition = false

    if (latitude !== null && longitude !== null) {
        createBox(
            parseFloat(latitude),
            parseFloat(longitude)
        )
    }

    let idPos = null

    function createBox(latitude, longitude) {
        const box = document.createElement('a-box')

        box.setAttribute('material', {
            color: 'red'
        })

        box.setAttribute('scale', {
            x: 5,
            y: 5,
            z: 5
        })

        box.setAttribute('gps-new-entity-place', {
            latitude: latitude,
            longitude: longitude
        })

        document.querySelector('a-scene').appendChild(box)

        posBlock.innerHTML = `Block:<br>latitude: ${latitude}<br>longitude: ${longitude}`
    }

    function success(pos) {
        const crd = pos.coords

        posGps.innerHTML = `Your current position:<br>latitude: ${crd.latitude}<br>longitude: ${crd.longitude}<br>accuracy: ${crd.accuracy}`

        if (!setPosition) {
            camera.setAttribute('gps-new-entity-place', {
                latitude: crd.latitude,
                longitude: crd.longitude
            })
        }

        setPosition = true

        // setTimeout(getPosition, 5000)

        // if (target.latitude === crd.latitude && target.longitude === crd.longitude) {
        //     console.log("Congratulations, you reached the target");
        //     navigator.geolocation.clearWatch(id);
        // }
    }

    function error() {
        // setTimeout(getPosition, 5000)
    }

    idPos = navigator.geolocation.watchPosition(
        success,
        error,
        options
    )
</script>
</html>