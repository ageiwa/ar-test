<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Page</title>
    <script type="text/javascript" src="/aframe.min.js"></script>
    <script type="text/javascript" src="/ar-threex-location-only.js"></script>
    <script type="text/javascript" src="/aframe-ar.js"></script>
    <script type="text/javascript" src="/aframe-look-at-component.min.js"></script>
</head>

<body>
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false" renderer="antialias: true; alpha: true">
        <a-camera gps-new-camera='gpsMinDistance: 5'></a-camera>
    </a-scene>
</body>

<script>
    let markersIsSet = false

    const urlParams = new URLSearchParams(window.parent.location.search)
    const latitude = urlParams.get('latitude')
    const longitude = urlParams.get('longitude')
    const stamps = urlParams.get('stamps')

    function createBox({lat, long, stamp}) {
        const marker = document.createElement('a-entity')
        marker.setAttribute('gps-new-entity-place', {
            latitude: lat,
            longitude: long
        })

        marker.setAttribute('material', {
            color: 'red'
        })

        marker.setAttribute('geometry', {
            primitive: 'box'
        })

        marker.setAttribute('obj-model', {
            obj: '/untitled.obj',
            mtl: '/untitled.mtl'
        })

        if (stamp) {
            const stampText = document.createElement('a-text')
            stampText.setAttribute('align', 'center')
            stampText.setAttribute('value', stamp)
            stampText.setAttribute('color', '#fff')
            stampText.setAttribute('baseline', 'top')
            stampText.setAttribute('z-offset', '-10')
            stampText.setAttribute('look-at', '[gps-new-camera]')
            marker.appendChild(stampText)
        }

        document
            .querySelector('a-scene')
            .appendChild(marker)
    }

    const camera = document.querySelector('[gps-new-camera]')
    camera.addEventListener('gps-camera-update-position', (e) => {
        if (!markersIsSet && latitude !== null && longitude !== null) {
            const latList = latitude.split(',')
            const lngList = longitude.split(',')
            const stmpList = stamps.split(',')

            latList.forEach((_, i) => {
                createBox({
                    lat: parseFloat(latList[i]),
                    long: parseFloat(lngList[i]),
                    stamp: stmpList[i]
                })
            })
        }

        markersIsSet = true
    })
</script>

</html>